<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <style>
        /* Basic styling for the app container and welcome view */
        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            justify-content: center; /* Center horizontally */
            align-items: center;     /* Center vertically */
            min-height: 100vh;       /* Take full viewport height */
            background-color: #f4f4f4; /* Light background for the page */
        }
        #app {
            width: 100%;
            display: flex;
            flex-direction: column; /* Stack children vertically */
            align-items: center;    /* Center children horizontally */
        }
        .form-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px; /* Limit width for popup effect */
            text-align: center; /* Center content within the container */
        }
        .welcome-container { /* Style for the welcome message area */
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        form {
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            text-align: left; /* Align labels to the left */
            color: #555;
            font-weight: bold;
        }
        input[type="text"], input[type="password"] {
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: calc(100% - 22px); /* Full width minus padding/border */
            box-sizing: border-box; /* Include padding/border in width */
            font-size: 1em;
        }
        .dob-group {
            display: flex; /* Use flexbox for DOB inputs */
            justify-content: space-between; /* Distribute space between inputs */
            margin-bottom: 15px;
        }
        .dob-group input {
            width: calc(33% - 10px); /* Roughly 1/3rd width minus some margin */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center; /* Center text in DOB inputs */
            font-size: 1em;
        }
        .dob-group input:not(:last-child) {
            margin-right: 10px; /* Space between inputs */
        }
        button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%; /* Make button full width */
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        #message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 5px;
            /*display: none;  Hidden by default */
            font-weight: bold;
            text-align: left; /* Align messages to the left */
        }
        #message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
    <!-- Include Vue.js (Version 3 - Composition API for modern Vue) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <login-view v-if="!isLoggedIn" @login-attempt="processLoginAttempt"></login-view>
        <welcome-view v-else :user-name="welcomeName" @logout-request="processLogout"></welcome-view>

        <!-- Global message display -->
        <div id="message" :class="messageType" v-if="messageText">{{ messageText }}</div>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;

        // --- LoginView Component ---
        const LoginView = {
            template: `
                <div class="form-container">
                    <h1>Login</h1>
                    <form @submit.prevent="submitLogin">
                        <label for="loginLastName">Last Name:</label>
                        <input type="text" id="loginLastName" v-model.trim="form.lastName" required><br>
                        <label for="loginFirstName">First Name:</label>
                        <input type="text" id="loginFirstName" v-model.trim="form.firstName" required><br>

                        <label>Date of Birth:</label>
                        <div class="dob-group">
                            <input type="text" id="loginDobMonth" v-model.trim="form.dobMonth" placeholder="MM" maxlength="2" required @input="autoTab('dobDayInput', 2, $event)" ref="dobMonthInput">
                            <input type="text" id="loginDobDay" v-model.trim="form.dobDay" placeholder="DD" maxlength="2" required ref="dobDayInput">
                            <input type="text" id="loginDobYear" v-model.trim="form.dobYear" placeholder="YYYY" maxlength="4" required @input="autoTab('dobMonthInput', 4, $event)">
                        </div><br>

                        <button type="submit">Login</button>
                    </form>
                </div>
            `,
            emits: ['login-attempt'], // Declare events this component can emit
            setup(props, { emit }) { // Destructure `emit` from the context object
                const form = reactive({
                    lastName: '',
                    firstName: '',
                    dobYear: '',
                    dobMonth: '',
                    dobDay: ''
                });

                const dobMonthInput = ref(null);
                const dobDayInput = ref(null);

                function padZero(numStr) {
                    const num = parseInt(numStr);
                    if (!isNaN(num) && numStr.length === 1 && num >= 0 && num <= 9) {
                        return String(num).padStart(2, '0');
                    }
                    return numStr;
                }

                function autoTab(nextFieldRefName, maxLength, event) {
                    const currentInput = event.target;
                    if (currentInput.value.length === maxLength && currentInput.value.match(/^\d+$/)) {
                        if (nextFieldRefName === 'dobMonthInput' && dobMonthInput.value) {
                            dobMonthInput.value.focus();
                        } else if (nextFieldRefName === 'dobDayInput' && dobDayInput.value) {
                            dobDayInput.value.focus();
                        } else if (nextFieldRefName === 'dobYearInput' && dobYearInput.value) {
                            dobYearInput.value.focus();
                        }
                    }
                }

                function submitLogin() {
                    if (!form.lastName || !form.firstName || !form.dobYear || !form.dobMonth || !form.dobDay) {
                        // Emit an event with error information for the parent to handle
                        emit('login-attempt', {
                            success: false,
                            error: 'Please fill in all fields.',
                            data: null
                        });
                        return;
                    }

                    form.dobMonth = padZero(form.dobMonth);
                    form.dobDay = padZero(form.dobDay);

                    const year = parseInt(form.dobYear);
                    const month = parseInt(form.dobMonth);
                    const day = parseInt(form.dobDay);

                    if (isNaN(year) || isNaN(month) || isNaN(day) ||
                        month < 1 || month > 12 ||
                        day < 1 || day > 31 ||
                        year < 1900 || year > new Date().getFullYear() + 1) {
                        emit('login-attempt', {
                            success: false,
                            error: 'Please enter a valid date of birth (MM-DD-YYYY).',
                            data: null
                        });
                        return;
                    }

                    const date = new Date(year, month - 1, day);
                    if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
                        emit('login-attempt', {
                            success: false,
                            error: 'Invalid date. Please check month and day values.',
                            data: null
                        });
                        return;
                    }

                    const dob = `${form.dobMonth}-${form.dobDay}-${form.dobYear}`;
                    let reqData = {
                        lastName: form.lastName,
                        firstName: form.firstName,
                        dob
                    };
                    emit('login-attempt', {
                        success: true,
                        data: reqData,
                        error: null
                    });
                }

                return {
                    form,
                    submitLogin,
                    autoTab,
                    padZero,
                    dobMonthInput,
                    dobDayInput
                };
            }
        };

        // --- WelcomeView Component ---
        const WelcomeView = {
            props: ['userName'], // Props received from parent
            emits: ['logout-request'],
            template: `
                <div class="welcome-container">
                    <h1>Welcome, {{ userName }}!</h1>
                    <p>You have successfully logged in.</p>
                    <button @click="$emit('logout-request')">Logout</button>
                </div>
            `
        };

        // --- Main Vue App ---
        createApp({
            components: { // Register the components
                LoginView,
                WelcomeView
            },
            setup() {
                const isLoggedIn = ref(false);
                const messageText = ref('');
                const messageType = ref(''); // 'success' or 'error'
                const welcomeName = ref('');

                async function processLoginAttempt(payload) {
                    messageText.value = '';
                    messageType.value = '';

                    if (!payload.success) {
                        messageText.value = payload.error;
                        messageType.value = 'error';
                        return;
                    }

                    const { lastName, firstName, dob }  = payload.data;

                    try {
                        let reqData = {
                            lastName,
                            firstName,
                            dob
                        };
                        const response = await fetch('/api/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(reqData)
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            isLoggedIn.value = true;
                            welcomeName.value = lastName; // Use the lastName from the successful login
                            messageText.value = data.message;
                            messageType.value = 'success';
                        } else {
                            messageText.value = data.message || 'Login failed.';
                            messageType.value = 'error';
                        }
                    } catch (error) {
                        console.error('Error during login:', error);
                        messageText.value = 'An error occurred during login. Please try again.';
                        messageType.value = 'error';
                    }
                }

                function processLogout() {
                    isLoggedIn.value = false;
                    welcomeName.value = '';
                    messageText.value = 'You have been logged out.';
                    messageType.value = 'success';
                }

                return {
                    isLoggedIn,
                    messageText,
                    messageType,
                    welcomeName,
                    processLoginAttempt,
                    processLogout
                };
            }
        }).mount('#app');
    </script>
</body>
</html>